name: Update Kubewarden chart versions

sources:
  defaultChartVersion:
    name: Load chart version
    kind: yaml
    spec:
      file: "file://charts/kubewarden-defaults/Chart.yaml"
      key: "version"
  defaultChartValuesFile:
    kind: yaml
    spec:
      file: "charts/kubewarden-defaults/chart-values.yaml"
      key: 'policyServer.image.tag'
  defaultValuesFile:
    kind: yaml
    spec:
      file: "charts/kubewarden-defaults/values.yaml"
      key: 'policyServer.image.tag'
  controllerChartAppVersion:
    name: Load chart app version
    kind: yaml
    spec:
      file: "file://charts/kubewarden-controller/Chart.yaml"
      key: "appVersion"
  controllerChartVersion:
    name: Load controller chart version
    kind: yaml
    spec:
      file: "file://charts/kubewarden-controller/Chart.yaml"
      key: "version"

targets:
  defaultUpdateChartValuesFile:
    name: "Update container image in the chart-values.yaml file"
    kind: yaml
    sourceid: defaultChartValuesFile
    scmid: "default"
    spec:
      file: "charts/kubewarden-defaults/chart-values.yaml"
      key: 'policyServer.image.tag'
      value: '{{ requiredEnv .releaseVersion }}'
  defaultUpdateValuesFile:
    kind: yaml
    name: "Update container image in the values.yaml file"
    sourceid: defaultValuesFile
    scmid: "default"
    spec:
      file: "charts/kubewarden-defaults/values.yaml"
      key: 'policyServer.image.tag'
      value: '{{ requiredEnv .releaseVersion }}'
  defaultChartVersionUpdate:
    name: Bump defaults chart version
    kind: yaml
    sourceid: defaultChartVersion
    scmid: "default"
    transformers:
      - semverinc: '{{ requiredEnv .semverinc }}'
    spec:
      file: "file://charts/kubewarden-defaults/Chart.yaml"
      key: "version"
  defaultChartVersionUpdate2:
    name: Bump defaults chart version in annotations
    kind: yaml
    sourceid: defaultChartVersion
    scmid: "default"
    transformers:
      - semverinc: '{{ requiredEnv .semverinc }}'
    spec:
      file: "file://charts/kubewarden-defaults/Chart.yaml"
      key: 'annotations.catalog\.cattle\.io/upstream-version'
  controllerChartAppVersionUpdate:
    name: Bump controller chart app version
    kind: yaml
    sourceid: controllerChartAppVersion
    scmid: "default"
    transformers:
      - semverinc: '{{ requiredEnv .semverinc }}'
    spec:
      file: "file://charts/kubewarden-controller/Chart.yaml"
      key: "appVersion"
  controllerChartVersionUpdate:
    name: Bump controller chart version
    kind: yaml
    sourceid: controllerChartVersion
    scmid: "default"
    transformers:
      - semverinc: '{{ requiredEnv .semverinc }}'
    spec:
      file: "file://charts/kubewarden-controller/Chart.yaml"
      key: "version"
  controllerChartVersionUpdate2:
    name: Bump controller chart version in annotations
    kind: yaml
    sourceid: controllerChartVersion
    scmid: "default"
    transformers:
      - semverinc: '{{ requiredEnv .semverinc }}'
    spec:
      file: "file://charts/kubewarden-controller/Chart.yaml"
      key: 'annotations.catalog\.cattle\.io/upstream-version'

actions:
  createUpdatePR:
    title: "Create PR to update Helm charts"
    helm-charts:
    kind: "github/pullrequest"
    scmid: "default"
    spec:
      automerge: false
      mergemethod: squash
      description: |
        Automatic Helm chart update.
        This PR has been created by the automation used to automatically update the Helm charts when some Kubewarden component is released

        REMEMBER TO SQUASH THE COMMIT BEFORE MERGING THIS PR!
      draft: false
      labels:
        - "kind/enhancement"

scms:
  default:
    kind: github
    spec:
      user: "{{ .github.author }}"
      email: "{{ .github.email }}"
      directory: "/tmp/helm-charts"
      owner: "{{ requiredEnv .github.owner }}"
      repository: "helm-charts"
      token: "{{ requiredEnv .github.token }}"
      username: "{{ requiredEnv .github.user }}"
      branch: "{{ .github.branch }}"
      commitmessage:
        type: "fix"
        title: "Update Kubewarden Helm charts"
        hidecredit: true
