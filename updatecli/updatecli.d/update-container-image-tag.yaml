name: Update container image tag used in the chart

sources:
  source/chartValuesFile:
    kind: yaml
    spec:
      file: "charts/{{ requiredEnv .chart  }}/chart-values.yaml"
      key: '{{ requiredEnv .containerImageTagValuePath }}'

  source/valuesFile:
    kind: yaml
    spec:
      file: "charts/{{ requiredEnv .chart  }}/values.yaml"
      key: '{{ requiredEnv .containerImageTagValuePath }}'

targets:
  target/updateChartValuesFile:
    name: "Update container image in the chart-values.yaml file"
    kind: yaml
    sourceid: source/chartValuesFile
    scmid: "default"
    spec:
      file: "charts/{{ requiredEnv .chart  }}/chart-values.yaml"
      key: '{{ requiredEnv .containerImageTagValuePath }}'
      value: '{{ requiredEnv .releaseVersion }}'

  target/updateValuesFile:
    kind: yaml
    name: "Update container image in the values.yaml file"
    sourceid: source/valuesFile
    scmid: "default"
    spec:
      file: "charts/{{ requiredEnv .chart  }}/values.yaml"
      key: '{{ requiredEnv .containerImageTagValuePath }}'
      value: '{{ requiredEnv .releaseVersion }}'

actions:
  action/createUpdatePR:
    helm-charts:
    kind: "github/pullrequest"
    scmid: "default"
    spec:
      automerge: true
      mergemethod: squash
      description: "Helm chart update"
      draft: false
      labels:
        - "kind/enhancement"
      title: "Helm chart update"

scms:
  default:
    kind: github
    spec:
      user: "{{ .github.author }}"
      email: "{{ .github.email }}"
      directory: "myhelmcharts"
      owner: "{{ requiredEnv .github.owner }}"
      repository: "helm-charts"
      token: "{{ requiredEnv .github.token }}"
      username: "{{ requiredEnv .github.user }}"
      branch: "{{ .github.branch }}"
      commitmessage:
        type: "{{ requiredEnv .updateType }}"
        title: "Update container images"
